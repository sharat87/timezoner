const devMode="1"===localStorage.devMode,CityStore=(()=>{const e=new Map;let t=null;return fetch("cities.txt").then(e=>e.text()).then(n=>{const[o,i]=n.split("\n\n"),r=new Map;for(const e of o.split("\n"))e.length&&r.set(...e.split("\t"));e.clear();for(const t of i.split("\n"))if(t.length){const[n,o,i,a]=t.split("\t"),m={name:n,country:r.get(o),population:i,timezone:a,key:o+n};e.set(m.key,m)}t=new Fuse(Array.from(e.values()),{includeMatches:!0,keys:[{name:"name",weight:2},{name:"country",weight:1}]}),migrateZoneStorage(),m.redraw()}),{get data(){return e},has:t=>e.has(t),get:t=>e.get(t),search:(...e)=>null===t?[]:t.search(...e)}})(),model={currentUtc:roundedTo15(moment.utc()),cities:loadCities(),addCity(e){this.cities.push(e),saveCities()},delCity(e){model.cities.splice(model.cities.indexOf(e),1),console.log(model.cities),saveCities()}};function Main(){return{view:function(){const e=[m(zoneForm,{key:"UTC",timezone:"UTC",currentUtc:model.currentUtc,isDeletable:!1})];for(const t of model.cities)if(CityStore.has(t)){const{name:n,country:o,timezone:i}=CityStore.get(t);e.push(m(zoneForm,{key:t,title:`${n}, ${o}`,timezone:i,currentUtc:model.currentUtc,isDeletable:!0}))}else e.push(m("tr",{key:t},m("td",{colspan:3},t)));return[m("h1","~ Timezoner ~"),m("table.cities",[m("tbody",e),m("tbody",[m("tr",m("td",{colspan:3},m(addCityForm)))])]),devMode&&m("pre",JSON.stringify(model,null,2))]}}}function zoneForm(){return{view:function(e){const{key:t,title:n,timezone:o,currentUtc:i,isDeletable:r}=e.attrs,a=i.tz(o),[s,l,u,c,d,f,p,y]=a.format("YYYY MM DD hh mm A zz ZZ").split(" ");return m("tr.zone",[m("td",r&&m(deleteButton,{onclick(){model.delCity(t)}})),m("td.name",[m("span",n||o),n&&m("span.subtext",[o,m.trust(" &middot; "),p+" = UTC"+y])]),m("td",[m(numInput,{key:t,timezone:o,name:"year",value:s}),m("span.sep",{key:"s1"},m.trust("&ndash;")),m(numInput,{key:t,timezone:o,name:"month",value:l}),m("span.sep",{key:"s2"},m.trust("&ndash;")),m(numInput,{key:t,timezone:o,name:"date",value:u}),m("span.sep",{key:"s3"},m.trust("&middot;")),m(numInput,{key:t,timezone:o,name:"hour",value:c}),m("span.sep",{key:"s4"},":"),m(numInput,{key:t,timezone:o,name:"minute",value:d}),m("span.sep",{key:"s5"}," "),m(numInput,{key:t,timezone:o,name:"meridian",value:f})])])}}}function deleteButton(){return{view:function(e){return m("svg.delete-btn",{onclick:e.attrs.onclick},[m("circle",{r:"45%",cx:"50%",cy:"50%"}),m("line",{x1:"25%",y1:"50%",x2:"75%",y2:"50%"})])}}}function numInput(e){let t=null,{key:n,name:o,value:i,timezone:r}=e.attrs;return{view:function(e){return n=e.attrs.key,o=e.attrs.name,i=e.attrs.value,r=e.attrs.timezone,m("input.num",{required:!0,name:o,value:t||i,oninput:a,onblur:s,onkeydown:l,onwheel:u})}};function a(e){t=e.target.value,model.currentUtc=model.currentUtc.tz(r).set(o,e.target.value).utc()}function s(){t=null}function l(e){if("ArrowUp"===e.key||"ArrowDown"===e.key)e.preventDefault(),s(),modify(o,e.key.endsWith("Up")?1:-1);else if("ArrowLeft"===e.key||"ArrowRight"===e.key){const t=e.target.selectionStart;if(0===t&&"ArrowLeft"===e.key){let t=e.target.previousElementSibling;for(;t&&t.previousElementSibling&&!t.matches("input.num");)t=t.previousElementSibling;t&&(t.focus(),t.selectionStart=t.value.length,e.preventDefault(),s())}else if(t===e.target.value.length&&"ArrowRight"===e.key){let t=e.target.nextElementSibling;for(;t&&t.nextElementSibling&&!t.matches("input.num");)t=t.nextElementSibling;t&&(t.focus(),t.selectionEnd=0,e.preventDefault(),s())}}}function u(e){e.preventDefault(),s(),modify(o,-Math.sign(e.deltaY))}}function addCityForm(){let e="";const t=[];let n="",o=0,i=0;return{view:function(){return m("form.zone",{style:{position:"relative"}},[m("input.zone-input.name",{placeholder:"Add city",value:e,onkeydown:s,oninput:a}),m("div.search-results-box",t.map(({item:e},t)=>m("a",{href:"#",class:t===i?"active":"",onclick:r},[e.name,", ",e.country])))])}};function r(n){if(n&&n.preventDefault&&n.preventDefault(),t.length>0){const{item:n}=t[i];model.addCity(n.key),t.splice(0,t.length),e=""}}function a(t){e=t.target.value}function s(a){"ArrowUp"===a.key?(a.preventDefault(),i>0&&--i):"ArrowDown"===a.key?(a.preventDefault(),i<t.length-1&&++i):"Enter"===a.key?r(a):"Escape"===a.key?e&&(a.preventDefault(),t.splice(0,t.length),e=""):setTimeout((function(){const e=a.target.value.toLowerCase();if(n===e)return;const r=++o,s=CityStore.search(e).slice(0,10);r===o&&(t.splice(0,t.length,...s),i=0,n=e,m.redraw())}))}}function modify(e,t){let n=1;"meridian"===e?[n,e]=[12,"h"]:"minute"===e?n=15:"date"===e&&(e="d"),model.currentUtc.add(n*t,e)}function roundedTo15(e){if(e instanceof moment){const t=e.second(0).minute()%15;return t>=8&&e.add(15,"m"),e.subtract(t,"m")}{const t=(e=Math.round(parseFloat(e)))%15;return t>=8&&(e+=15),e-t}}function saveCities(){localStorage.setItem("cities",JSON.stringify(model.cities))}function loadCities(){const e=["INMumbai","USNew York City","GBLondon","NLAmsterdam"],t=localStorage.getItem("cities");if(!t)return e;const n=JSON.parse(t);return n&&Array.isArray(n)&&0!==n.length?n:e}function migrateZoneStorage(){let e=localStorage.getItem("zones");if(!e)return;const t=[],n=new Set(JSON.parse(e));for(const e of n)for(const[n,{timezone:o}]of CityStore.data)if(o===e){t.push(n);break}localStorage.removeItem("zones"),model.cities=t,saveCities()}window.addEventListener("load",()=>m.mount(document.getElementById("app"),Main));