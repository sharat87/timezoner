const devMode="1"===localStorage.devMode;window.addEventListener("load",start);const CityStore=(()=>{let e=!1;const t=new Map;let n=0;return fetch("cities.txt").then(e=>e.text()).then(n=>{const[o,i]=n.split("\n\n"),r=new Map;for(const e of o.split("\n"))e.length&&r.set(e.substr(0,2),e.substr(2));t.clear();for(const e of i.split("\n"))if(e.length){const[n,o,i]=e.split("\t"),s=r.get(o);let a=o+n;t.set(a,{name:n,country:s,timezone:i,key:a,searchRep:deburr(n).toLowerCase()})}migrateZoneStorage(),e=!0}),{get isReady(){return e},get data(){return t},has:e=>t.has(e),get:e=>t.get(e),search(e,o){const i=++n;return new Promise((r,s)=>{0===(e=e.trim().toLowerCase()).length&&r([]);const a=[],u=[];for(const r of t.values()){if(r.searchRep.includes(e)&&((r.searchRep.startsWith(e)?a:u).push({item:r}),a.length>=o))break;i!==n&&s()}r(a.concat(...u).slice(0,o))})}}})(),model={currentUtc:roundedTo15(moment.utc()),cities:loadCities(),addCity(e){this.cities.push(e),saveCities()},delCity(e){model.cities.splice(model.cities.indexOf(e),1),console.log(model.cities),saveCities()}};function start(){m.mount(document.getElementById("app"),Main)}function Main(){return{view:function(){const e=[m(zoneForm,{key:"UTC",timezone:"UTC",currentUtc:model.currentUtc,isDeletable:!1})];for(const t of model.cities)if(CityStore.has(t)){const{name:n,country:o,timezone:i}=CityStore.get(t);e.push(m(zoneForm,{key:t,title:`${n}, ${o}`,timezone:i,currentUtc:model.currentUtc,isDeletable:!0}))}else e.push(m("tr",{key:t},m("td",{colspan:3},t)));return[m("table.cities",[m("tbody",e),m("tbody",[m("tr",m("td",{colspan:3},m(addCityForm)))])]),devMode&&m("pre",JSON.stringify(model,null,2))]}}}function zoneForm(){return{view:function(e){const{key:t,title:n,timezone:o,currentUtc:i,isDeletable:r}=e.attrs,s=i.tz(o),[a,u,l,c,d,f,p,y]=s.format("YYYY MM DD hh mm A zz ZZ").split(" ");return m("tr.zone",[m("td",r&&m(deleteButton,{onclick(){model.delCity(t)}})),m("td.name",[m("span",n||o),n&&m("span.subtext",[o,m.trust(" &middot; "),p+" = UTC"+y])]),m("td",[m(numInput,{key:t,timezone:o,name:"year",value:a}),m("span.sep",{key:"s1"},m.trust("&ndash;")),m(numInput,{key:t,timezone:o,name:"month",value:u}),m("span.sep",{key:"s2"},m.trust("&ndash;")),m(numInput,{key:t,timezone:o,name:"date",value:l}),m("span.sep",{key:"s3"},m.trust("&middot;")),m(numInput,{key:t,timezone:o,name:"hour",value:c}),m("span.sep",{key:"s4"},":"),m(numInput,{key:t,timezone:o,name:"minute",value:d}),m("span.sep",{key:"s5"}," "),m(numInput,{key:t,timezone:o,name:"meridian",value:f})])])}}}function deleteButton(){return{view:function(e){return m("svg.delete-btn",{onclick:e.attrs.onclick},[m("circle",{r:"45%",cx:"50%",cy:"50%"}),m("line",{x1:"25%",y1:"50%",x2:"75%",y2:"50%"})])}}}function numInput(e){let t=null,{key:n,name:o,value:i,timezone:r}=e.attrs;return{view:function(e){return n=e.attrs.key,o=e.attrs.name,i=e.attrs.value,r=e.attrs.timezone,m("input.num",{required:!0,name:o,value:t||i,oninput:s,onblur:a,onkeydown:u,onwheel:l})}};function s(e){t=e.target.value,model.currentUtc=model.currentUtc.tz(r).set(o,e.target.value).utc()}function a(){t=null}function u(e){if("ArrowUp"===e.key||"ArrowDown"===e.key)e.preventDefault(),a(),modify(o,e.key.endsWith("Up")?1:-1);else if("ArrowLeft"===e.key||"ArrowRight"===e.key){const t=e.target.selectionStart;if(0===t&&"ArrowLeft"===e.key){let t=e.target.previousElementSibling;for(;t&&t.previousElementSibling&&!t.matches("input.num");)t=t.previousElementSibling;t&&(t.focus(),t.selectionStart=t.value.length,e.preventDefault(),a())}else if(t===e.target.value.length&&"ArrowRight"===e.key){let t=e.target.nextElementSibling;for(;t&&t.nextElementSibling&&!t.matches("input.num");)t=t.nextElementSibling;t&&(t.focus(),t.selectionEnd=0,e.preventDefault(),a())}}}function l(e){e.preventDefault(),a(),modify(o,-Math.sign(e.deltaY))}}function addCityForm(){let e="";const t=[];let n="",o=0;return{view:function(){return m("form.zone",{style:{position:"relative"}},[m("input.zone-input.name",{placeholder:CityStore.isReady?"Add city":"Loading cities...",value:e,onkeydown:s,oninput:r}),e&&m("div.search-results-box",CityStore.isReady?0===t.length?"No matches found.":t.map(({item:e},t)=>m("a",{href:"#",class:t===o?"active":"",onclick:i},`${e.name}, ${e.country}`)):m.trust("Loading cities for search, please wait&hellip;"))])}};function i(n){if(n&&n.preventDefault&&n.preventDefault(),t.length>0){const{item:n}=t[o];model.addCity(n.key),t.splice(0,t.length),e=""}}function r(t){e=t.target.value,setTimeout(a)}function s(n){"ArrowUp"===n.key?(n.preventDefault(),o>0&&--o):"ArrowDown"===n.key?(n.preventDefault(),o<t.length-1&&++o):"Enter"===n.key?i(n):"Escape"===n.key&&e&&(n.preventDefault(),t.splice(0,t.length),e="")}function a(){const i=e.toLowerCase();n!==i&&CityStore.search(i,10).then(e=>{t.splice(0,t.length,...e),o=0,n=i,m.redraw()}).catch(()=>console.info("Search rejected for "+i))}}function modify(e,t){let n=1;"meridian"===e?[n,e]=[12,"h"]:"minute"===e?n=15:"date"===e&&(e="d"),model.currentUtc.add(n*t,e)}function roundedTo15(e){if(e instanceof moment){const t=e.second(0).minute()%15;return t>=8&&e.add(15,"m"),e.subtract(t,"m")}{const t=(e=Math.round(parseFloat(e)))%15;return t>=8&&(e+=15),e-t}}function saveCities(){localStorage.setItem("cities",JSON.stringify(model.cities))}function loadCities(){const e=["INMumbai","USNew York City","GBLondon","NLAmsterdam"],t=localStorage.getItem("cities");if(!t)return e;const n=JSON.parse(t);return n&&Array.isArray(n)&&0!==n.length?n:e}function migrateZoneStorage(){let e=localStorage.getItem("zones");if(!e)return;const t=[],n=new Set(JSON.parse(e));for(const e of n)for(const[n,{timezone:o}]of CityStore.data)if(o===e){t.push(n);break}localStorage.removeItem("zones"),model.cities=t,saveCities()}const deburr=(()=>{const e=/[\xc0-\xd6\xd8-\xf6\xf8-\xff\u0100-\u017f]/g,t=/\u0300-\u036f\ufe20-\ufe23\u20d0-\u20f0]/g,n={"À":"A","Á":"A","Â":"A","Ã":"A","Ä":"A","Å":"A","à":"a","á":"a","â":"a","ã":"a","ä":"a","å":"a","Ç":"C","ç":"c","Ð":"D","ð":"d","È":"E","É":"E","Ê":"E","Ë":"E","è":"e","é":"e","ê":"e","ë":"e","Ì":"I","Í":"I","Î":"I","Ï":"I","ì":"i","í":"i","î":"i","ï":"i","Ñ":"N","ñ":"n","Ò":"O","Ó":"O","Ô":"O","Õ":"O","Ö":"O","Ø":"O","ò":"o","ó":"o","ô":"o","õ":"o","ö":"o","ø":"o","Ù":"U","Ú":"U","Û":"U","Ü":"U","ù":"u","ú":"u","û":"u","ü":"u","Ý":"Y","ý":"y","ÿ":"y","Æ":"Ae","æ":"ae","Þ":"Th","þ":"th","ß":"ss","Ā":"A","Ă":"A","Ą":"A","ā":"a","ă":"a","ą":"a","Ć":"C","Ĉ":"C","Ċ":"C","Č":"C","ć":"c","ĉ":"c","ċ":"c","č":"c","Ď":"D","Đ":"D","ď":"d","đ":"d","Ē":"E","Ĕ":"E","Ė":"E","Ę":"E","Ě":"E","ē":"e","ĕ":"e","ė":"e","ę":"e","ě":"e","Ĝ":"G","Ğ":"G","Ġ":"G","Ģ":"G","ĝ":"g","ğ":"g","ġ":"g","ģ":"g","Ĥ":"H","Ħ":"H","ĥ":"h","ħ":"h","Ĩ":"I","Ī":"I","Ĭ":"I","Į":"I","İ":"I","ĩ":"i","ī":"i","ĭ":"i","į":"i","ı":"i","Ĵ":"J","ĵ":"j","Ķ":"K","ķ":"k","ĸ":"k","Ĺ":"L","Ļ":"L","Ľ":"L","Ŀ":"L","Ł":"L","ĺ":"l","ļ":"l","ľ":"l","ŀ":"l","ł":"l","Ń":"N","Ņ":"N","Ň":"N","Ŋ":"N","ń":"n","ņ":"n","ň":"n","ŋ":"n","Ō":"O","Ŏ":"O","Ő":"O","ō":"o","ŏ":"o","ő":"o","Ŕ":"R","Ŗ":"R","Ř":"R","ŕ":"r","ŗ":"r","ř":"r","Ś":"S","Ŝ":"S","Ş":"S","Š":"S","ś":"s","ŝ":"s","ş":"s","š":"s","Ţ":"T","Ť":"T","Ŧ":"T","ţ":"t","ť":"t","ŧ":"t","Ũ":"U","Ū":"U","Ŭ":"U","Ů":"U","Ű":"U","Ų":"U","ũ":"u","ū":"u","ŭ":"u","ů":"u","ű":"u","ų":"u","Ŵ":"W","ŵ":"w","Ŷ":"Y","ŷ":"y","Ÿ":"Y","Ź":"Z","Ż":"Z","Ž":"Z","ź":"z","ż":"z","ž":"z","Ĳ":"IJ","ĳ":"ij","Œ":"Oe","œ":"oe","ŉ":"'n","ſ":"ss"};function o(e){return n[e]||e}return function(n){return n.replace(e,o).replace(t,"")}})();